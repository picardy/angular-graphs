"use strict";angular.module("picardy.graphs.bar",["picardy.graphs.common"]).directive("d3GraphBar",["common","$rootScope",function(a,b){function c(b,c){function d(){return"vertical"===r.orientation}function e(b,c){x.append("text").text(b).attr("transform",function(){return u.label=this.getBBox().height,d()?"rotate(-90) "+a.translate(-10,u.label):a.translate(r.width,u.info+u.label)}).style({"text-anchor":"end",fill:s("labels"),done:c})}function f(){var a;return a=r.max&&r.max.y?[0,r.max.y]:[0,d3.max(r.data,function(a){return a.y})]}function g(){return r.data.map(function(a){return a.x})}function h(b){var c,e,h=r.height;d()?(h-=u.info,h-=u.top,w=d3.scale.linear().range([h,0]),e=f(),w.domain(e)):(h-=u.info+u.label+21,w=d3.scale.ordinal().rangeRoundBands([0,h],.2),e=g(),w.domain(e)),c=d3.svg.axis().scale(w).orient("left"),d()||c.tickFormat(""),y.append("g").call(c).attr({"class":"y axis",transform:function(){var b=0,c=1;return d()?(u.yAxis=this.getBBox().width,b=u.label+u.yAxis+20,c+=u.top):(b+=20,c+=u.info+u.label+20),a.translate(b,c)},done:b}).selectAll("text").style("fill",s("axes"))}function i(){var b,c,e=r.width-21;d()?(e-=u.label+u.yAxis,v=d3.scale.ordinal().rangeRoundBands([0,e],.2),c=g(),v.domain(c)):(v=d3.scale.linear().range([e,0]),c=f(),v.domain(c)),b=d3.svg.axis().scale(v).orient(d()?"bottom":"top"),b.tickFormat(""),y.append("g").call(b).attr({"class":"x axis",transform:function(){var b=20,c=1;return d()?a.translate(b+u.label+u.yAxis,c+r.height-u.info):a.translate(b,c+u.info+u.label+20)}}).selectAll("text").style("fill",s("axes")).attr("transform",a.translate(0,10))}function j(a){h(function(){i(),y.selectAll(".axis path, .axis line").style({fill:"none",stroke:s("axes"),"shape-rendering":"crispEdges"}),a()})}function k(a){return r.infoFormat.replace("{x}",a.x).replace("{y}",a.y)}function l(a,b){d3.select(a).attr("fill",s(b?"focusedBar":"bars"))}function m(b,c){c?A.append("text").text(k(b)).attr({"text-anchor":d()?"middle":"left","alignment-baseline":"central",transform:function(){var c,e,f,g,h;return d()?(f=this.getBBox().width/2,e=r.height-this.getBBox().height,c=u.label+u.yAxis+20+v(b.x)+v.rangeBand()/2,g=r.width-f,h=u.label+u.yAxis+20+f,c=Math.max(h,Math.min(g,c))):(c=20,e=u.info/2),a.translate(c,e)}}):A.selectAll("text").remove()}function n(a){l(this,!0),m(a,!0)}function o(a){l(this,!1),m(a,!1)}function p(){var b={"class":"bar",fill:s("bars"),width:d()?v.rangeBand():0,height:d()?0:w.rangeBand(),transform:function(b){return d()?a.translate(u.label+u.yAxis+20+v(b.x),u.top+w(b.y)+1):a.translate(20,u.info+u.label+w(b.x)+21)}};d()?b.height=function(a){return r.height-u.top-u.info-w(a.y)}:b.width=function(a){return r.width-v(a.y)-21},z.selectAll(".bar").data(r.data).enter().append("rect").attr(b).on({mouseover:n,mouseout:o})}function q(){var b;t&&t.remove(),a.defaults(r,{ratioWidth:2,ratioHeight:1}),r.width=c[0].getBoundingClientRect().width,b=r.width/r.ratioWidth,r.height=r.ratioHeight*b,t=a.initSvg(c[0],r.width,r.height),x=a.newLayer(t,"labels"),z=a.newLayer(t,"bars"),y=a.newLayer(t,"axes"),A=a.newLayer(t,"info"),e(r.labels.y,function(){j(function(){p()})})}var r,r,s,t,u,v,w,x,y,z,A;b.data&&(r=angular.copy(b.data),s=a.colors(r.colors),a.defaults(r,{infoFormat:"{y} Â· {x}",orientation:"vertical"}),u={top:10,info:50},q(),a.onWindowResize(q))}return a.define(b,c)}]),angular.module("picardy.graphs.line",["picardy.graphs.common"]).directive("d3GraphLine",["common","$rootScope",function(a,b){function c(b,c){function d(){var b,c;b=d3.svg.axis().scale(o).ticks(d3.time.daysTotal,h.dateStep).tickFormat(d3.time.format(h.dateFormat)).orient("bottom"),r.append("g").attr({"class":"x axis",transform:a.translate(l.left,n)}).call(b).selectAll("text").style("fill",j("axes")).attr("transform",a.translate(0,10)),c=d3.svg.axis().scale(p).orient("left"),r.append("g").attr({"class":"y axis",transform:a.translate(l.left,0)}).call(c).selectAll("text").style("fill",j("axes")),r.selectAll(".axis path, .axis line").style({fill:"none",stroke:j("axes"),"shape-rendering":"crispEdges"})}function e(b){q.append("text").attr("transform","rotate(-90) "+a.translate(0,l.left+20)).style({"text-anchor":"end",fill:j("labels")}).text(b)}function f(){var b,c,d;b=d3.svg.line().interpolate("linear").x(function(a){return o(a.x)}).y(function(a){return p(a.y)}),c=s.append("path").datum(i).attr({transform:a.translate(l.left,0),"class":"line",d:b}),d=c.node().getTotalLength(),s.selectAll(".line").style({fill:"none",stroke:j("lines"),"stroke-width":"1.5px"})}function g(){var b;k&&k.remove(),a.defaults(h,{ratioWidth:2,ratioHeight:1,dateStep:3,dateFormat:"%a %d"}),h.width=c[0].getBoundingClientRect().width,b=h.width/h.ratioWidth,h.height=h.ratioHeight*b,k=a.initSvg(c[0],h.width,h.height),q=a.newLayer(k,"labels"),s=a.newLayer(k,"lines"),r=a.newLayer(k,"axes"),l={top:20,right:20,bottom:30,left:50},m=h.width-l.left-l.right,n=h.height-l.top-l.bottom,o=d3.time.scale().range([0,m-20]),p=d3.scale.linear().range([n,20]),o.domain(d3.extent(i,function(a){return a.x})),p.domain([0,d3.max(i,function(a){return a.y})]),d(),e(h.labels.y),f()}var h,i,h,j,k,l,m,n,o,p,q,r,s;b.data&&(h=angular.copy(b.data),j=a.colors(h.colors),i=[],angular.forEach(h.data,function(a){a.x>0&&(a.x=new Date(a.x)),i.push(a)}),g(),a.onWindowResize(g))}return a.define(b,c)}]),angular.module("picardy.graphs.pie",["picardy.graphs.common"]).directive("d3GraphPie",["common","$rootScope",function(a,b){function c(b,c){function d(a){return a.data.label}function e(a,b){var c=m.selectAll("path.slice").data(s(a),d);b||(b=0),c.enter().insert("path").style("fill",function(a){return a.data.color}).attr("class","slice"),c.transition().duration(b).attrTween("d",function(a){var b;return this._current=this._current||a,b=d3.interpolate(this._current,a),function(a){var c=b(a);return v.text(Math.round(c.value)+"%"),t(c)}})}function f(a){return a.startAngle+(a.endAngle-a.startAngle)/2}function g(a){var b=o.selectAll("polyline").data(s(a),d);b.enter().append("polyline").style({opacity:"0.3",stroke:k("lines"),"stroke-width":"2px",fill:"none"}).attr("points",function(a){var b=u.centroid(a);return b[0]=.95*r*(f(a)<Math.PI?1:-1),[t.centroid(a),u.centroid(a),b]}),b.exit().remove()}function h(b){var c=n.selectAll("text").data(s(b),d);c.enter().append("text").text(function(a){return a.data.label}).attr({dy:".35em",transform:function(b){var c=u.centroid(b);return c[0]=r*(f(b)<Math.PI?1:-1),a.translate(c)}}).style({fill:k("labels"),"text-anchor":function(a){return f(a)<Math.PI?"start":"end"}})}var i,j,i,k,l,m,n,o,p,q,r,s,t,u,v;b.data&&(i=angular.copy(b.data),k=a.colors(i.colors),j={start:[],end:[]},a.defaults(i,{height:300,delay:500,duration:1e3}),void 0===i.width&&(i.width=i.height+(i.labels?200:0)),l=a.initSvg(c[0],i.width,i.height),angular.forEach(i.start,function(a,b){var c=i.labels?i.labels[b]:Math.random(),d=k("slices",b);j.start.push({value:i.start[b],label:c,color:d}),j.end.push({value:i.end[b],label:c,color:d})}),i.pieWidth=300,i.pieHeight=300,m=a.newLayer(l,"slices"),o=a.newLayer(l,"lines"),n=a.newLayer(l,"labels"),p=a.newLayer(l,"text"),l.selectAll("g").attr("transform",function(){return a.translate(i.width/2,i.height/2)}),q=Math.min(i.pieWidth,i.pieHeight),r=q/2,s=d3.layout.pie().value(function(a){return a.value}).sort(null),t=d3.svg.arc().outerRadius(.8*r).innerRadius(.4*r),u=d3.svg.arc().innerRadius(.9*r).outerRadius(.9*r),v=p.append("text").attr({"text-anchor":"middle","alignment-baseline":"central",style:"font-size: "+i.pieWidth/6+"px",fill:k("amount")}),e(j.start),setTimeout(function(){e(j.end,i.duration),i.labels&&setTimeout(function(){g(j.end),h(j.end)},i.duration)},i.delay))}return a.define(b,c)}]),angular.module("picardy.graphs.common",[]).factory("common",["$window",function(a){function b(a,b,c){return function(d,e,f){var g=a(d),h=[];if(d>g&&b(g),f>1)for(;e>g;){var i=new Date(+g);c(i)%f||h.push(i),b(g)}else for(;e>g;)h.push(new Date(+g)),b(g);return h}}d3.time.daysTotal=b(d3.time.day,function(a){a.setDate(a.getDate()+1)},function(a){return~~(a/864e5)});var c={define:function(a,b){return{restrict:"E",scope:{render:"=",data:"="},link:function(c,d,e){a[e.render]=function(a){c.data=a,b(c,d,e)}}}},initSvg:function(a,b,c){return a.innerHTML="",d3.select(a).append("svg").attr({width:b,height:c})},colors:function(a){return function(b,c){var d;return a&&(d=a[b])?void 0===c?d:d.length>c?d[c]:d3.scale.category10().range()[c]:"black"}},newLayer:function(a,b){return a.append("g").attr("class",b)},defaults:function(a,b){var c;for(c in b)void 0===a[c]&&b.hasOwnProperty(c)&&(a[c]=b[c]);return a},translate:function(a,b){return"translate("+a+(void 0===b?"":","+b)+")"},onWindowResize:function(b){var c=angular.element(a);c.bind("resize",b)}};return c}]);
"use strict";angular.module("picardy.graphs.line",["picardy.graphs.common"]).directive("d3GraphLine",["common","$rootScope",function(a,b){function c(b,c){function d(){var b,c;b=d3.svg.axis().scale(p).ticks(d3.time.days,3).tickFormat(d3.time.format("%a %d")).orient("bottom"),s.append("g").attr({"class":"x axis",transform:a.translate(m.left,o)}).call(b).selectAll("text").style("fill",j("axes")).attr("transform",a.translate(0,10)),c=d3.svg.axis().scale(q).orient("left"),s.append("g").attr({"class":"y axis",transform:a.translate(m.left,0)}).call(c).selectAll("text").style("fill",j("axes")),s.selectAll(".axis path, .axis line").style({fill:"none",stroke:j("axes"),"shape-rendering":"crispEdges"})}function e(){r.append("text").attr("transform","rotate(-90) "+a.translate(0,m.left+20)).style({"text-anchor":"end",fill:j("labels")}).text("Completion (%)")}function f(b,c){var d,e,f;f=d3.svg.line().interpolate("linear").x(function(a){return p(a.x)}).y(function(a){return q(a.y)}),d=t.append("path").datum(h).attr({transform:a.translate(m.left,0),"class":"line",d:f}),e=d.node().getTotalLength(),d.attr({"stroke-dasharray":e+" "+e,"stroke-dashoffset":e}).transition().duration(c).delay(b).ease("linear").attr("stroke-dashoffset",0),t.selectAll(".line").style({fill:"none",stroke:j("lines"),"stroke-width":"1.5px"})}var g,h,i,j,k,l,m,n,o,p,q,r,s,t;b.data&&(g=angular.copy(b.data),j=a.colors(g.colors),h=[],i=a.defaults(g,{height:300,delay:500,duration:1e3}),i.width=void 0===b.width?2*i.height:b.width,k=a.initSvg(c[0],i.width,i.height),r=a.newLayer(k,"labels"),t=a.newLayer(k,"lines"),s=a.newLayer(k,"axes"),m={top:20,right:20,bottom:30,left:50},n=i.width-m.left-m.right,o=i.height-m.top-m.bottom,l=d3.time.format("%d-%b-%y").parse,angular.forEach(g.x,function(a,b){h.push({x:l(a),y:g.y[b]})}),p=d3.time.scale().range([0,n-20]),q=d3.scale.linear().range([o,20]),p.domain(d3.extent(h,function(a){return a.x})),q.domain([0,d3.max(h,function(a){return a.y})]),k.attr({width:n+m.left+m.right,height:o+m.top+m.bottom}),d(),e(),f(i.delay,i.duration))}return a.define(b,c)}]),angular.module("picardy.graphs.pie",["picardy.graphs.common"]).directive("d3GraphPie",["common","$rootScope",function(a,b){function c(b,c){function d(a){return a.data.label}function e(a,b){var c=n.selectAll("path.slice").data(t(a),d);b||(b=0),c.enter().insert("path").style("fill",function(a){return a.data.color}).attr("class","slice"),c.transition().duration(b).attrTween("d",function(a){var b;return this._current=this._current||a,b=d3.interpolate(this._current,a),function(a){var c=b(a);return w.text(Math.round(c.value)+"%"),u(c)}})}function f(a){return a.startAngle+(a.endAngle-a.startAngle)/2}function g(a){var b=p.selectAll("polyline").data(t(a),d);b.enter().append("polyline").style({opacity:"0.3",stroke:l("lines"),"stroke-width":"2px",fill:"none"}).attr("points",function(a){var b=v.centroid(a);return b[0]=.95*s*(f(a)<Math.PI?1:-1),[u.centroid(a),v.centroid(a),b]}),b.exit().remove()}function h(b){var c=o.selectAll("text").data(t(b),d);c.enter().append("text").text(function(a){return a.data.label}).attr({dy:".35em",transform:function(b){var c=v.centroid(b);return c[0]=s*(f(b)<Math.PI?1:-1),a.translate(c)}}).style({fill:l("labels"),"text-anchor":function(a){return f(a)<Math.PI?"start":"end"}})}var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;b.data&&(i=angular.copy(b.data),l=a.colors(i.colors),j={start:[],end:[]},k=a.defaults(i,{height:300,delay:500,duration:1e3}),k.labels=i.labels&&i.labels.length,k.width=void 0===i.width?k.height+(k.labels?200:0):i.width,m=a.initSvg(c[0],k.width,k.height),angular.forEach(i.start,function(a,b){var c=k.labels?i.labels[b]:Math.random(),d=l("slices",b);j.start.push({value:i.start[b],label:c,color:d}),j.end.push({value:i.end[b],label:c,color:d})}),k.pieWidth=300,k.pieHeight=300,n=a.newLayer(m,"slices"),p=a.newLayer(m,"lines"),o=a.newLayer(m,"labels"),q=a.newLayer(m,"text"),m.selectAll("g").attr("transform",function(){return a.translate(k.width/2,k.height/2)}),r=Math.min(k.pieWidth,k.pieHeight),s=r/2,t=d3.layout.pie().value(function(a){return a.value}).sort(null),u=d3.svg.arc().outerRadius(.8*s).innerRadius(.4*s),v=d3.svg.arc().innerRadius(.9*s).outerRadius(.9*s),w=q.append("text").attr({"text-anchor":"middle","alignment-baseline":"central",style:"font-size: "+k.pieWidth/6+"px",fill:l("amount")}),e(j.start),setTimeout(function(){e(j.end,k.duration),k.labels&&setTimeout(function(){g(j.end),h(j.end)},k.duration)},k.delay))}return a.define(b,c)}]),angular.module("picardy.graphs.common",[]).factory("common",function(){var a={define:function(a,b){return{restrict:"E",scope:{render:"=",data:"="},link:function(c,d,e){a[e.render]=function(a){c.data=a,b(c,d,e)}}}},initSvg:function(a,b,c){return d3.select(a).append("svg").attr("viewBox",[0,0,b,c].join(" "))},colors:function(a){return function(b,c){var d;return a&&(d=a[b])?void 0===c?d:d.length>c?d[c]:d3.scale.category10().range()[c]:"black"}},newLayer:function(a,b){return a.append("g").attr("class",b)},defaults:function(a,b){var c,d={};for(c in b)void 0===a[c]&&b.hasOwnProperty(c)&&(d[c]=b[c]);return d},translate:function(a,b){return"translate("+a+(void 0===b?"":","+b)+")"}};return a});
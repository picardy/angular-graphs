"use strict";angular.module("picardy.graphs.bar",["picardy.graphs.common"]).directive("d3GraphBar",["common","$rootScope",function(a,b){function c(b,c){function d(){var b,c;b=d3.svg.axis().scale(q).orient("bottom"),c=d3.svg.axis().scale(r).orient("left"),b.tickFormat(""),t.append("g").attr({"class":"x axis",transform:a.translate(n.left,p+1)}).call(b).selectAll("text").style("fill",l("axes")).attr("transform",a.translate(0,10)),t.append("g").attr({"class":"y axis",transform:a.translate(n.left,1)}).call(c).selectAll("text").style("fill",l("axes")),t.selectAll(".axis path, .axis line").style({fill:"none",stroke:l("axes"),"shape-rendering":"crispEdges"})}function e(b){s.append("text").attr("transform","rotate(-90) "+a.translate(-10,20)).style({"text-anchor":"end",fill:l("labels")}).text(b)}function f(a,b){d3.select(a).attr("fill",l(b?"focusedBar":"bars"))}function g(b,c){c?v.append("text").attr({transform:a.translate(n.left+q(b.x)+q.rangeBand()/2,p+40),"text-anchor":"middle","alignment-baseline":"central"}).text(b.x+" "+b.y):v.selectAll("text").remove()}function h(a){f(this,!0),g(a,!0)}function i(a){f(this,!1),g(a,!1)}function j(b,c){u.selectAll(".bar").data(k.data).enter().append("rect").attr({"class":"bar",width:q.rangeBand(),height:0,transform:function(b){return a.translate(n.left+q(b.x),p+1)},fill:l("bars")}).on({mouseover:h,mouseout:i}).transition().delay(b).duration(c).attr("transform",function(b){return a.translate(n.left+q(b.x),r(b.y)+1)}).attr("height",function(a){return p-r(a.y)})}var k,k,l,m,n,o,p,q,r,s,t,u,v;b.data&&(k=angular.copy(b.data),l=a.colors(k.colors),a.defaults(k,{height:300,delay:500,duration:1e3}),void 0===k.width&&(k.width=2*k.height),m=a.initSvg(c[0],k.width,k.height),s=a.newLayer(m,"labels"),u=a.newLayer(m,"bars"),t=a.newLayer(m,"axes"),v=a.newLayer(m,"info"),n={top:20,right:20,bottom:30,left:125},o=k.width-n.left-n.right,p=k.height-n.top-n.bottom,q=d3.scale.ordinal().rangeRoundBands([0,o],.2),r=d3.scale.linear().range([p,0]),q.domain(k.data.map(function(a){return a.x})),r.domain([0,d3.max(k.data,function(a){return a.y})]),m.attr({width:o+n.left+n.right,height:p+n.top+n.bottom}),d(),e(k.labels.y),j(k.delay,k.duration))}return a.define(b,c)}]),angular.module("picardy.graphs.line",["picardy.graphs.common"]).directive("d3GraphLine",["common","$rootScope",function(a,b){function c(b,c){function d(){var b,c;b=d3.svg.axis().scale(o).ticks(d3.time.days,3).tickFormat(d3.time.format("%a %d")).orient("bottom"),r.append("g").attr({"class":"x axis",transform:a.translate(l.left,n)}).call(b).selectAll("text").style("fill",i("axes")).attr("transform",a.translate(0,10)),c=d3.svg.axis().scale(p).orient("left"),r.append("g").attr({"class":"y axis",transform:a.translate(l.left,0)}).call(c).selectAll("text").style("fill",i("axes")),r.selectAll(".axis path, .axis line").style({fill:"none",stroke:i("axes"),"shape-rendering":"crispEdges"})}function e(b){q.append("text").attr("transform","rotate(-90) "+a.translate(0,l.left+20)).style({"text-anchor":"end",fill:i("labels")}).text(b)}function f(b,c){var d,e,f;f=d3.svg.line().interpolate("linear").x(function(a){return o(a.x)}).y(function(a){return p(a.y)}),d=s.append("path").datum(h).attr({transform:a.translate(l.left,0),"class":"line",d:f}),e=d.node().getTotalLength(),d.attr({"stroke-dasharray":e+" "+e,"stroke-dashoffset":e}).transition().duration(c).delay(b).ease("linear").attr("stroke-dashoffset",0),s.selectAll(".line").style({fill:"none",stroke:i("lines"),"stroke-width":"1.5px"})}var g,h,g,i,j,k,l,m,n,o,p,q,r,s;b.data&&(g=angular.copy(b.data),i=a.colors(g.colors),h=[],a.defaults(g,{height:300,delay:500,duration:1e3}),void 0===g.width&&(g.width=2*g.height),j=a.initSvg(c[0],g.width,g.height),q=a.newLayer(j,"labels"),s=a.newLayer(j,"lines"),r=a.newLayer(j,"axes"),l={top:20,right:20,bottom:30,left:50},m=g.width-l.left-l.right,n=g.height-l.top-l.bottom,k=d3.time.format("%d-%b-%y").parse,angular.forEach(g.data,function(a){a.x=k(a.x),h.push(a)}),o=d3.time.scale().range([0,m-20]),p=d3.scale.linear().range([n,20]),o.domain(d3.extent(h,function(a){return a.x})),p.domain([0,d3.max(h,function(a){return a.y})]),j.attr({width:m+l.left+l.right,height:n+l.top+l.bottom}),d(),e(g.labels.y),f(g.delay,g.duration))}return a.define(b,c)}]),angular.module("picardy.graphs.pie",["picardy.graphs.common"]).directive("d3GraphPie",["common","$rootScope",function(a,b){function c(b,c){function d(a){return a.data.label}function e(a,b){var c=m.selectAll("path.slice").data(s(a),d);b||(b=0),c.enter().insert("path").style("fill",function(a){return a.data.color}).attr("class","slice"),c.transition().duration(b).attrTween("d",function(a){var b;return this._current=this._current||a,b=d3.interpolate(this._current,a),function(a){var c=b(a);return v.text(Math.round(c.value)+"%"),t(c)}})}function f(a){return a.startAngle+(a.endAngle-a.startAngle)/2}function g(a){var b=o.selectAll("polyline").data(s(a),d);b.enter().append("polyline").style({opacity:"0.3",stroke:k("lines"),"stroke-width":"2px",fill:"none"}).attr("points",function(a){var b=u.centroid(a);return b[0]=.95*r*(f(a)<Math.PI?1:-1),[t.centroid(a),u.centroid(a),b]}),b.exit().remove()}function h(b){var c=n.selectAll("text").data(s(b),d);c.enter().append("text").text(function(a){return a.data.label}).attr({dy:".35em",transform:function(b){var c=u.centroid(b);return c[0]=r*(f(b)<Math.PI?1:-1),a.translate(c)}}).style({fill:k("labels"),"text-anchor":function(a){return f(a)<Math.PI?"start":"end"}})}var i,j,i,k,l,m,n,o,p,q,r,s,t,u,v;b.data&&(i=angular.copy(b.data),k=a.colors(i.colors),j={start:[],end:[]},a.defaults(i,{height:300,delay:500,duration:1e3}),void 0===i.width&&(i.width=i.height+(i.labels?200:0)),l=a.initSvg(c[0],i.width,i.height),angular.forEach(i.start,function(a,b){var c=i.labels?i.labels[b]:Math.random(),d=k("slices",b);j.start.push({value:i.start[b],label:c,color:d}),j.end.push({value:i.end[b],label:c,color:d})}),i.pieWidth=300,i.pieHeight=300,m=a.newLayer(l,"slices"),o=a.newLayer(l,"lines"),n=a.newLayer(l,"labels"),p=a.newLayer(l,"text"),l.selectAll("g").attr("transform",function(){return a.translate(i.width/2,i.height/2)}),q=Math.min(i.pieWidth,i.pieHeight),r=q/2,s=d3.layout.pie().value(function(a){return a.value}).sort(null),t=d3.svg.arc().outerRadius(.8*r).innerRadius(.4*r),u=d3.svg.arc().innerRadius(.9*r).outerRadius(.9*r),v=p.append("text").attr({"text-anchor":"middle","alignment-baseline":"central",style:"font-size: "+i.pieWidth/6+"px",fill:k("amount")}),e(j.start),setTimeout(function(){e(j.end,i.duration),i.labels&&setTimeout(function(){g(j.end),h(j.end)},i.duration)},i.delay))}return a.define(b,c)}]),angular.module("picardy.graphs.common",[]).factory("common",function(){var a={define:function(a,b){return{restrict:"E",scope:{render:"=",data:"="},link:function(c,d,e){a[e.render]=function(a){c.data=a,b(c,d,e)}}}},initSvg:function(a,b,c){return d3.select(a).append("svg").attr("viewBox",[0,0,b,c].join(" "))},colors:function(a){return function(b,c){var d;return a&&(d=a[b])?void 0===c?d:d.length>c?d[c]:d3.scale.category10().range()[c]:"black"}},newLayer:function(a,b){return a.append("g").attr("class",b)},defaults:function(a,b){var c;for(c in b)void 0===a[c]&&b.hasOwnProperty(c)&&(a[c]=b[c]);return a},translate:function(a,b){return"translate("+a+(void 0===b?"":","+b)+")"}};return a});
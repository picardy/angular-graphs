"use strict";angular.module("picardy.graphs.bar",["picardy.graphs.common"]).directive("d3GraphBar",["common","$rootScope",function(a,b){function c(b,c){function d(){return"vertical"===q.orientation}function e(b,c){w.append("text").text(b).attr("transform",function(){return t.label=this.getBBox().height,d()?"rotate(-90) "+a.translate(-10,t.label):a.translate(q.width,t.info+t.label)}).style({"text-anchor":"end",fill:r("labels"),done:c})}function f(){var a;return a=q.max&&q.max.y?[0,q.max.y]:[0,d3.max(q.data,function(a){return a.y})]}function g(){return q.data.map(function(a){return a.x})}function h(b){var c,e,h=q.height;d()?(h-=t.info,h-=t.top,v=d3.scale.linear().range([h,0]),e=f(),v.domain(e)):(h-=t.info+t.label+21,v=d3.scale.ordinal().rangeRoundBands([0,h],.2),e=g(),v.domain(e)),c=d3.svg.axis().scale(v).orient("left"),d()||c.tickFormat(""),x.append("g").call(c).attr({"class":"y axis",transform:function(){var b=0,c=1;return d()?(t.yAxis=this.getBBox().width,b=t.label+t.yAxis+20,c+=t.top):(b+=20,c+=t.info+t.label+20),a.translate(b,c)},done:b}).selectAll("text").style("fill",r("axes"))}function i(){var b,c,e=q.width-21;d()?(e-=t.label+t.yAxis,u=d3.scale.ordinal().rangeRoundBands([0,e],.2),c=g(),u.domain(c)):(u=d3.scale.linear().range([e,0]),c=f(),u.domain(c)),b=d3.svg.axis().scale(u).orient(d()?"bottom":"top"),b.tickFormat(""),x.append("g").call(b).attr({"class":"x axis",transform:function(){var b=20,c=1;return d()?a.translate(b+t.label+t.yAxis,c+q.height-t.info):a.translate(b,c+t.info+t.label+20)}}).selectAll("text").style("fill",r("axes")).attr("transform",a.translate(0,10))}function j(a){h(function(){i(),x.selectAll(".axis path, .axis line").style({fill:"none",stroke:r("axes"),"shape-rendering":"crispEdges"}),a()})}function k(a){return q.infoFormat.replace("{x}",a.x).replace("{y}",a.y)}function l(a,b){d3.select(a).attr("fill",r(b?"focusedBar":"bars"))}function m(b,c){c?z.append("text").text(k(b)).attr({"text-anchor":d()?"middle":"left","alignment-baseline":"central",transform:function(){var c,e,f,g,h;return d()?(f=this.getBBox().width/2,e=q.height-this.getBBox().height,c=t.label+t.yAxis+20+u(b.x)+u.rangeBand()/2,g=q.width-f,h=t.label+t.yAxis+20+f,c=Math.max(h,Math.min(g,c))):(c=20,e=t.info/2),a.translate(c,e)}}):z.selectAll("text").remove()}function n(a){l(this,!0),m(a,!0)}function o(a){l(this,!1),m(a,!1)}function p(){var b={transform:function(b){return d()?a.translate(t.label+t.yAxis+20+u(b.x),t.top+v(b.y)+1):a.translate(20,t.info+t.label+v(b.x)+21)}};d()?b.height=function(a){return q.height-t.top-t.info-v(a.y)}:b.width=function(a){return q.width-u(a.y)-21},y.selectAll(".bar").data(q.data).enter().append("rect").attr({"class":"bar",fill:r("bars"),width:d()?u.rangeBand():0,height:d()?0:v.rangeBand(),transform:function(b){return d()?a.translate(t.label+t.yAxis+20+u(b.x),q.height-t.info+1):a.translate(20,t.info+t.label+v(b.x)+21)}}).on({mouseover:n,mouseout:o}).transition().delay(q.delay).duration(q.duration).attr(b)}var q,q,r,s,t,u,v,w,x,y,z;b.data&&(q=angular.copy(b.data),r=a.colors(q.colors),a.defaults(q,{delay:500,duration:1e3,infoFormat:"{y} Â· {x}",orientation:"vertical"}),d()?(a.defaults(q,{height:300}),void 0===q.width&&(q.width=2*q.height)):(a.defaults(q,{width:300}),void 0===q.height&&(q.height=2*q.width)),c[0].children.length>0&&c[0].children[0].remove(),s=a.initSvg(c[0],q.width,q.height),w=a.newLayer(s,"labels"),y=a.newLayer(s,"bars"),x=a.newLayer(s,"axes"),z=a.newLayer(s,"info"),t={top:10,info:50},s.attr({width:q.width,height:q.height}),e(q.labels.y,function(){j(function(){p()})}))}return a.define(b,c)}]),angular.module("picardy.graphs.line",["picardy.graphs.common"]).directive("d3GraphLine",["common","$rootScope",function(a,b){function c(b,c){function d(){var b,c;b=d3.svg.axis().scale(n).ticks(d3.time.days,3).tickFormat(d3.time.format("%a %d")).orient("bottom"),q.append("g").attr({"class":"x axis",transform:a.translate(k.left,m)}).call(b).selectAll("text").style("fill",i("axes")).attr("transform",a.translate(0,10)),c=d3.svg.axis().scale(o).orient("left"),q.append("g").attr({"class":"y axis",transform:a.translate(k.left,0)}).call(c).selectAll("text").style("fill",i("axes")),q.selectAll(".axis path, .axis line").style({fill:"none",stroke:i("axes"),"shape-rendering":"crispEdges"})}function e(b){p.append("text").attr("transform","rotate(-90) "+a.translate(0,k.left+20)).style({"text-anchor":"end",fill:i("labels")}).text(b)}function f(b,c){var d,e,f;f=d3.svg.line().interpolate("linear").x(function(a){return n(a.x)}).y(function(a){return o(a.y)}),d=r.append("path").datum(h).attr({transform:a.translate(k.left,0),"class":"line",d:f}),e=d.node().getTotalLength(),d.attr({"stroke-dasharray":e+" "+e,"stroke-dashoffset":e}).transition().duration(c).delay(b).ease("linear").attr("stroke-dashoffset",0),r.selectAll(".line").style({fill:"none",stroke:i("lines"),"stroke-width":"1.5px"})}var g,h,g,i,j,k,l,m,n,o,p,q,r;b.data&&(g=angular.copy(b.data),i=a.colors(g.colors),h=[],a.defaults(g,{height:300,delay:500,duration:1e3}),void 0===g.width&&(g.width=2*g.height),j=a.initSvg(c[0],g.width,g.height),p=a.newLayer(j,"labels"),r=a.newLayer(j,"lines"),q=a.newLayer(j,"axes"),k={top:20,right:20,bottom:30,left:50},l=g.width-k.left-k.right,m=g.height-k.top-k.bottom,angular.forEach(g.data,function(a){a.x>0&&(a.x=new Date(a.x)),h.push(a)}),n=d3.time.scale().range([0,l-20]),o=d3.scale.linear().range([m,20]),n.domain(d3.extent(h,function(a){return a.x})),o.domain([0,d3.max(h,function(a){return a.y})]),j.attr({width:l+k.left+k.right,height:m+k.top+k.bottom}),d(),e(g.labels.y),f(g.delay,g.duration))}return a.define(b,c)}]),angular.module("picardy.graphs.pie",["picardy.graphs.common"]).directive("d3GraphPie",["common","$rootScope",function(a,b){function c(b,c){function d(a){return a.data.label}function e(a,b){var c=m.selectAll("path.slice").data(s(a),d);b||(b=0),c.enter().insert("path").style("fill",function(a){return a.data.color}).attr("class","slice"),c.transition().duration(b).attrTween("d",function(a){var b;return this._current=this._current||a,b=d3.interpolate(this._current,a),function(a){var c=b(a);return v.text(Math.round(c.value)+"%"),t(c)}})}function f(a){return a.startAngle+(a.endAngle-a.startAngle)/2}function g(a){var b=o.selectAll("polyline").data(s(a),d);b.enter().append("polyline").style({opacity:"0.3",stroke:k("lines"),"stroke-width":"2px",fill:"none"}).attr("points",function(a){var b=u.centroid(a);return b[0]=.95*r*(f(a)<Math.PI?1:-1),[t.centroid(a),u.centroid(a),b]}),b.exit().remove()}function h(b){var c=n.selectAll("text").data(s(b),d);c.enter().append("text").text(function(a){return a.data.label}).attr({dy:".35em",transform:function(b){var c=u.centroid(b);return c[0]=r*(f(b)<Math.PI?1:-1),a.translate(c)}}).style({fill:k("labels"),"text-anchor":function(a){return f(a)<Math.PI?"start":"end"}})}var i,j,i,k,l,m,n,o,p,q,r,s,t,u,v;b.data&&(i=angular.copy(b.data),k=a.colors(i.colors),j={start:[],end:[]},a.defaults(i,{height:300,delay:500,duration:1e3}),void 0===i.width&&(i.width=i.height+(i.labels?200:0)),l=a.initSvg(c[0],i.width,i.height),angular.forEach(i.start,function(a,b){var c=i.labels?i.labels[b]:Math.random(),d=k("slices",b);j.start.push({value:i.start[b],label:c,color:d}),j.end.push({value:i.end[b],label:c,color:d})}),i.pieWidth=300,i.pieHeight=300,m=a.newLayer(l,"slices"),o=a.newLayer(l,"lines"),n=a.newLayer(l,"labels"),p=a.newLayer(l,"text"),l.selectAll("g").attr("transform",function(){return a.translate(i.width/2,i.height/2)}),q=Math.min(i.pieWidth,i.pieHeight),r=q/2,s=d3.layout.pie().value(function(a){return a.value}).sort(null),t=d3.svg.arc().outerRadius(.8*r).innerRadius(.4*r),u=d3.svg.arc().innerRadius(.9*r).outerRadius(.9*r),v=p.append("text").attr({"text-anchor":"middle","alignment-baseline":"central",style:"font-size: "+i.pieWidth/6+"px",fill:k("amount")}),e(j.start),setTimeout(function(){e(j.end,i.duration),i.labels&&setTimeout(function(){g(j.end),h(j.end)},i.duration)},i.delay))}return a.define(b,c)}]),angular.module("picardy.graphs.common",[]).factory("common",function(){var a={define:function(a,b){return{restrict:"E",scope:{render:"=",data:"="},link:function(c,d,e){a[e.render]=function(a){c.data=a,b(c,d,e)}}}},initSvg:function(a,b,c){return d3.select(a).append("svg").attr({viewBox:[0,0,b,c].join(" "),preserveAspectRatio:"xMinYMin meet"})},colors:function(a){return function(b,c){var d;return a&&(d=a[b])?void 0===c?d:d.length>c?d[c]:d3.scale.category10().range()[c]:"black"}},newLayer:function(a,b){return a.append("g").attr("class",b)},defaults:function(a,b){var c;for(c in b)void 0===a[c]&&b.hasOwnProperty(c)&&(a[c]=b[c]);return a},translate:function(a,b){return"translate("+a+(void 0===b?"":","+b)+")"}};return a});
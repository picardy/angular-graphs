"use strict";angular.module("picardy.graphs.bar",["picardy.graphs.common"]).directive("d3GraphBar",["common","$rootScope",function(a,b){function c(b,c){function d(){return"vertical"===o.orientation}function e(b,c){u.append("text").text(b).attr("transform",function(){return r.label=this.getBBox().height,d()?"rotate(-90) "+a.translate(-10,r.label):a.translate(o.width,r.info+r.label)}).style({"text-anchor":"end",fill:p("labels"),done:c})}function f(b){var c,e,f=o.height;d()?(f-=r.info,f-=r.top,t=d3.scale.linear().range([f,0]),e=o.max&&o.max.y?[0,o.max.y]:[0,d3.max(o.data,function(a){return a.y})],t.domain(e)):(f-=r.info+r.label+21,t=d3.scale.ordinal().rangeRoundBands([0,f],.2),e=o.max&&o.max.y?[0,o.max.y]:o.data.map(function(a){return a.x}),t.domain(e)),c=d3.svg.axis().scale(t).orient("left"),d()||c.tickFormat(""),v.append("g").call(c).attr({"class":"y axis",transform:function(){var b=0,c=1;return d()?(r.yAxis=this.getBBox().width,b=r.label+r.yAxis+20,c+=r.top):(b+=20,c+=r.info+r.label+20),a.translate(b,c)},done:b}).selectAll("text").style("fill",p("axes"))}function g(){var b,c,e=o.width-21;d()?(e-=r.label+r.yAxis,s=d3.scale.ordinal().rangeRoundBands([0,e],.2),c=o.max&&o.max.x?[0,o.max.x]:o.data.map(function(a){return a.x}),s.domain(c)):(s=d3.scale.linear().range([e,0]),c=o.max&&o.max.y?[0,o.max.y]:[0,d3.max(o.data,function(a){return a.y})],s.domain(c)),b=d3.svg.axis().scale(s).orient(d()?"bottom":"top"),b.tickFormat(""),v.append("g").call(b).attr({"class":"x axis",transform:function(){var b=20,c=1;return d()?a.translate(b+r.label+r.yAxis,c+o.height-r.info):a.translate(b,c+r.info+r.label+20)}}).selectAll("text").style("fill",p("axes")).attr("transform",a.translate(0,10))}function h(a){f(function(){g(),v.selectAll(".axis path, .axis line").style({fill:"none",stroke:p("axes"),"shape-rendering":"crispEdges"}),a()})}function i(a){return o.infoFormat.replace("{x}",a.x).replace("{y}",a.y)}function j(a,b){d3.select(a).attr("fill",p(b?"focusedBar":"bars"))}function k(b,c){c?x.append("text").text(i(b)).attr({"text-anchor":d()?"middle":"left","alignment-baseline":"central",transform:function(){var c,e,f,g,h;return d()?(f=this.getBBox().width/2,e=o.height-this.getBBox().height,c=r.label+r.yAxis+20+s(b.x)+s.rangeBand()/2,g=o.width-f,h=r.label+r.yAxis+20+f,c=Math.max(h,Math.min(g,c))):(c=20,e=r.info/2),a.translate(c,e)}}):x.selectAll("text").remove()}function l(a){j(this,!0),k(a,!0)}function m(a){j(this,!1),k(a,!1)}function n(){var b={transform:function(b){return d()?a.translate(r.label+r.yAxis+20+s(b.x),r.top+t(b.y)+1):a.translate(20,r.info+r.label+t(b.x)+21)}};d()?b.height=function(a){return o.height-r.top-r.info-t(a.y)}:b.width=function(a){return o.width-s(a.y)-21},w.selectAll(".bar").data(o.data).enter().append("rect").attr({"class":"bar",fill:p("bars"),width:d()?s.rangeBand():0,height:d()?0:t.rangeBand(),transform:function(b){return d()?a.translate(r.label+r.yAxis+20+s(b.x),o.height-r.info+1):a.translate(20,r.info+r.label+t(b.x)+21)}}).on({mouseover:l,mouseout:m}).transition().delay(o.delay).duration(o.duration).attr(b)}var o,o,p,q,r,s,t,u,v,w,x;b.data&&(o=angular.copy(b.data),p=a.colors(o.colors),a.defaults(o,{delay:500,duration:1e3,infoFormat:"{y} Â· {x}",orientation:"vertical"}),d()?(a.defaults(o,{height:300}),void 0===o.width&&(o.width=2*o.height)):(a.defaults(o,{width:300}),void 0===o.height&&(o.height=2*o.width)),c[0].children.length>0&&c[0].children[0].remove(),q=a.initSvg(c[0],o.width,o.height),u=a.newLayer(q,"labels"),w=a.newLayer(q,"bars"),v=a.newLayer(q,"axes"),x=a.newLayer(q,"info"),r={top:10,info:50},q.attr({width:o.width,height:o.height}),e(o.labels.y,function(){h(function(){n()})}))}return a.define(b,c)}]),angular.module("picardy.graphs.line",["picardy.graphs.common"]).directive("d3GraphLine",["common","$rootScope",function(a,b){function c(b,c){function d(){var b,c;b=d3.svg.axis().scale(o).ticks(d3.time.days,3).tickFormat(d3.time.format("%a %d")).orient("bottom"),r.append("g").attr({"class":"x axis",transform:a.translate(l.left,n)}).call(b).selectAll("text").style("fill",i("axes")).attr("transform",a.translate(0,10)),c=d3.svg.axis().scale(p).orient("left"),r.append("g").attr({"class":"y axis",transform:a.translate(l.left,0)}).call(c).selectAll("text").style("fill",i("axes")),r.selectAll(".axis path, .axis line").style({fill:"none",stroke:i("axes"),"shape-rendering":"crispEdges"})}function e(b){q.append("text").attr("transform","rotate(-90) "+a.translate(0,l.left+20)).style({"text-anchor":"end",fill:i("labels")}).text(b)}function f(b,c){var d,e,f;f=d3.svg.line().interpolate("linear").x(function(a){return o(a.x)}).y(function(a){return p(a.y)}),d=s.append("path").datum(h).attr({transform:a.translate(l.left,0),"class":"line",d:f}),e=d.node().getTotalLength(),d.attr({"stroke-dasharray":e+" "+e,"stroke-dashoffset":e}).transition().duration(c).delay(b).ease("linear").attr("stroke-dashoffset",0),s.selectAll(".line").style({fill:"none",stroke:i("lines"),"stroke-width":"1.5px"})}var g,h,g,i,j,k,l,m,n,o,p,q,r,s;b.data&&(g=angular.copy(b.data),i=a.colors(g.colors),h=[],a.defaults(g,{height:300,delay:500,duration:1e3}),void 0===g.width&&(g.width=2*g.height),j=a.initSvg(c[0],g.width,g.height),q=a.newLayer(j,"labels"),s=a.newLayer(j,"lines"),r=a.newLayer(j,"axes"),l={top:20,right:20,bottom:30,left:50},m=g.width-l.left-l.right,n=g.height-l.top-l.bottom,k=d3.time.format("%d-%b-%y").parse,angular.forEach(g.data,function(a){a.x=k(a.x),h.push(a)}),o=d3.time.scale().range([0,m-20]),p=d3.scale.linear().range([n,20]),o.domain(d3.extent(h,function(a){return a.x})),p.domain([0,d3.max(h,function(a){return a.y})]),j.attr({width:m+l.left+l.right,height:n+l.top+l.bottom}),d(),e(g.labels.y),f(g.delay,g.duration))}return a.define(b,c)}]),angular.module("picardy.graphs.pie",["picardy.graphs.common"]).directive("d3GraphPie",["common","$rootScope",function(a,b){function c(b,c){function d(a){return a.data.label}function e(a,b){var c=m.selectAll("path.slice").data(s(a),d);b||(b=0),c.enter().insert("path").style("fill",function(a){return a.data.color}).attr("class","slice"),c.transition().duration(b).attrTween("d",function(a){var b;return this._current=this._current||a,b=d3.interpolate(this._current,a),function(a){var c=b(a);return v.text(Math.round(c.value)+"%"),t(c)}})}function f(a){return a.startAngle+(a.endAngle-a.startAngle)/2}function g(a){var b=o.selectAll("polyline").data(s(a),d);b.enter().append("polyline").style({opacity:"0.3",stroke:k("lines"),"stroke-width":"2px",fill:"none"}).attr("points",function(a){var b=u.centroid(a);return b[0]=.95*r*(f(a)<Math.PI?1:-1),[t.centroid(a),u.centroid(a),b]}),b.exit().remove()}function h(b){var c=n.selectAll("text").data(s(b),d);c.enter().append("text").text(function(a){return a.data.label}).attr({dy:".35em",transform:function(b){var c=u.centroid(b);return c[0]=r*(f(b)<Math.PI?1:-1),a.translate(c)}}).style({fill:k("labels"),"text-anchor":function(a){return f(a)<Math.PI?"start":"end"}})}var i,j,i,k,l,m,n,o,p,q,r,s,t,u,v;b.data&&(i=angular.copy(b.data),k=a.colors(i.colors),j={start:[],end:[]},a.defaults(i,{height:300,delay:500,duration:1e3}),void 0===i.width&&(i.width=i.height+(i.labels?200:0)),l=a.initSvg(c[0],i.width,i.height),angular.forEach(i.start,function(a,b){var c=i.labels?i.labels[b]:Math.random(),d=k("slices",b);j.start.push({value:i.start[b],label:c,color:d}),j.end.push({value:i.end[b],label:c,color:d})}),i.pieWidth=300,i.pieHeight=300,m=a.newLayer(l,"slices"),o=a.newLayer(l,"lines"),n=a.newLayer(l,"labels"),p=a.newLayer(l,"text"),l.selectAll("g").attr("transform",function(){return a.translate(i.width/2,i.height/2)}),q=Math.min(i.pieWidth,i.pieHeight),r=q/2,s=d3.layout.pie().value(function(a){return a.value}).sort(null),t=d3.svg.arc().outerRadius(.8*r).innerRadius(.4*r),u=d3.svg.arc().innerRadius(.9*r).outerRadius(.9*r),v=p.append("text").attr({"text-anchor":"middle","alignment-baseline":"central",style:"font-size: "+i.pieWidth/6+"px",fill:k("amount")}),e(j.start),setTimeout(function(){e(j.end,i.duration),i.labels&&setTimeout(function(){g(j.end),h(j.end)},i.duration)},i.delay))}return a.define(b,c)}]),angular.module("picardy.graphs.common",[]).factory("common",function(){var a={define:function(a,b){return{restrict:"E",scope:{render:"=",data:"="},link:function(c,d,e){a[e.render]=function(a){c.data=a,b(c,d,e)}}}},initSvg:function(a,b,c){return d3.select(a).append("svg").attr({viewBox:[0,0,b,c].join(" "),preserveAspectRatio:"xMinYMin meet"})},colors:function(a){return function(b,c){var d;return a&&(d=a[b])?void 0===c?d:d.length>c?d[c]:d3.scale.category10().range()[c]:"black"}},newLayer:function(a,b){return a.append("g").attr("class",b)},defaults:function(a,b){var c;for(c in b)void 0===a[c]&&b.hasOwnProperty(c)&&(a[c]=b[c]);return a},translate:function(a,b){return"translate("+a+(void 0===b?"":","+b)+")"}};return a});